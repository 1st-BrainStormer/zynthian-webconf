
<h2>{{ title }}</h2>

<form id="presets-upload-form" action="/upload" enctype="multipart/form-data" method="post">
	{% module Template('upload.html', config=config) %}
</form>

<form id="presets-form" enctype="multipart/form-data" method="post">
<div class="container-fluid lib-treeview">

	<div class="row">

		<div class="col-md-5">
			<select id="ENGINE" name="ENGINE" onchange="load_preset_tree()">
				{% for key in config['engines'] %}
					<option value="{{key}}" {{ 'selected' if config['engine']==key else '' }}>{{config['engines'][key][1]}}</option>
				{% end %}
			</select>
			<div id="presets-tree"></div>
			<div id="loading-tree" class="text-center" style="display:none;">
				<br><br>
				<img src="/img/loading.gif">
			</div>
			<div class="row">
				<div id="error-message-tree" class="alert alert-danger" style="display:none">{{ errors }}</div>
			</div>
		</div>

		<div id="presets-panel" class="col-md-7">
			<input type="hidden" id="SEL_NODE_ID" name="SEL_NODE_ID" value="{{ escape(str(config['sel_node_id'])) }}">
			<input type="hidden" id="SEL_FULLPATH" name="SEL_FULLPATH">

			<div id="upload-panel">
				<button id="upload_show" class="btn btn-lg btn-theme btn-block">UPLOAD</button>
			</div>

			<br>

			<div id="presets-search-panel">
				<label for="MUSICAL_ARTIFACT_TAGS">Search Musical Artifacts:</label>
				<div class="row">
					<div class="col-md-9 col-sm-12">
						<input type="text" id="MUSICAL_ARTIFACT_TAGS" name="MUSICAL_ARTIFACT_TAGS" value="{{ escape(config['musical_artifact_tags']) }}" />
					</div>
					<div class="col-md-3 col-sm-12">
						<button id="ACTION_SEARCH" name="ACTION" value="SEARCH" class="btn btn-theme btn-block" onclick="showProgressAnimation()" >SEARCH</button>
					</div>
				</div>
				
				{% if 'SEARCH_RESULT' in config %}
				<table class="table table-striped table-bordered table-condensed">
				{% for row in config['SEARCH_RESULT'] %}
					<tr>
						<td title="{{ escape(row['description']) }}">
							{% if len(row['more_info'])>0 %}
								<a href="{{ row['more_info'][0] }}" target="_blank" >
									{{ row['name'] }}
								</a>
							{% else %}
								{{ row['name'] }}
							{% end %}
						</td>
						<td>
							<button name="ACTION" value="DOWNLOAD" class="btn btn-theme btn-block" onclick="showProgressAnimation();setDownloadFile('{{ escape(row['file']) }}')">+</button>
						</td>
					</tr>
				{% end %}
				</table>
				{% end %}
			</div>

			<div id="presets-new-bank-panel">
				<label>New Bank:</label>
				<div class="row">
					<div class="col-md-9 col-sm-12">
						<input type="text" id="NEW_BANK_NAME" name="NEW_BANK_NAME">
					</div>
					<div class="col-md-3 col-sm-12 text-center">
						<button id="button-new_bank" class="btn btn-theme btn-block" onclick="return do_action('new_bank')">CREATE</button>
						<span id="loading-action-new_bank" style="display:none;"><img src="/img/loading.gif"></span>
					</div>
				</div>
			</div>

			<div id="presets-bank-panel">
				<label for="SEL_BANK_NAME">Bank:</label>
				<div class="row">
					<div class="col-md-9 col-sm-12">
						<input type="text" id="SEL_BANK_NAME" name="SEL_BANK_NAME">
					</div>
					<div class="col-md-3 col-sm-12 text-center">
						<button id="button-rename_bank" class="btn btn-theme btn-block" onclick="return do_action('rename_bank')">RENAME</button>
						<span id="loading-action-rename_bank" style="display:none;"><img src="/img/loading.gif"></span>
					</div>
					<br><br>
					<div class="col-md-12 col-sm-12 text-center">
						<button name="ACTION" onclick="if (confirm('Are you sure to remove this bank and all its presets?')) return do_action('remove_bank')" class="btn btn-danger btn-block">DELETE</button>
						<span id="loading-action-remove_bank" style="display:none;"><img src="/img/loading.gif"></span>
					</div>
				</div>
			</div>


			<div id="presets-file-panel">
				<label for="SEL_PRESET_NAME">Preset:</label>
				<div class="row">
					<div class="col-md-9 col-sm-12">
						<input type="text" id="SEL_PRESET_NAME" name="SEL_PRESET_NAME">
					</div>
					<div class="col-md-3 col-sm-12 text-center">
						<button id="button-rename_preset" class="btn btn-theme btn-block" onclick="return do_action('rename_preset')">RENAME</button>
						<span id="loading-action-rename_preset" style="display:none;"><img src="/img/loading.gif"></span>
					</div>
					<br><br>
					<div class="col-md-12 col-sm-12 text-center">
						<button id="button-remove_preset" onclick="if (confirm('Are you sure to remove this preset?')) return do_action('remove_preset')" class="btn btn-danger btn-block">DELETE</button>
						<span id="loading-action-remove_preset" style="display:none;"><img src="/img/loading.gif"></span>
					</div>
				</div>
			</div>

			<br>

			<div id="download-panel">
				<button id="button-download" class="btn btn-lg btn-theme btn-block" onclick="do_download()">DOWNLOAD</button>
			</div>

			<div class="row">
				<div id="error-message-action" class="alert alert-danger" style="display:none"></div>
			</div>

		</div>
	</div>

</div>
</form>

<div id="loading-div-background">
  <div id="loading-div" class="ui-corner-all">
    PROCESSING. PLEASE WAIT...
  </div>
</div>

<script type="text/javascript">

var presetsForm = $('#presets-form')[0];

$(document).ready(function () {
	hideProgressAnimation()

	load_preset_tree()

/*
	$("#presets-form").submit(function(e) {
		return false
	})
*/
	
	$('#MUSICAL_ARTIFACT_TAGS').keypress(function(e) {
		// Enter pressed?
		if(e.which == 13) {
			e.preventDefault();
			$('#ACTION_SEARCH').click();
		}
	});

	var deferred = $.Deferred();
	deferred.done(function(value) {
		$("#upload_progress_panel").addClass("active");
		var socketMessage = {
			"handler_name": "UploadProgressHandler",
			"data": $('#input-uploadfile-session')[0].value
		};
		window.zynthianSocket.send(JSON.stringify(socketMessage));
	});
	connectZynthianWebSocket(deferred);

	$('#upload_panel')[0].onuploadend = function(response){
		console.log("upload succeded: " + response);
		var ajaxData = new FormData(presetsForm);
		ajaxData.append('ACTION','REVISE_UPLOAD')
		var ajax = new XMLHttpRequest();

		ajax.open( presetsForm.getAttribute( 'method' ), presetsForm.getAttribute( 'action' ), true );

		ajax.onload = function() 	{
			if( ajax.status >= 200 && ajax.status < 400 )	{
				if( ajax.status != 200) {
					console.log("upload error: " + data.errror);
				}
			}
			else alert( 'Error. Please, contact the webmaster!' );
		};

		ajax.onloadend = function() {
			console.log("revise uploads succeeded");
			window.location.href = window.location.href;
		};

		ajax.onerror = function() {
			console.log("revise uploads failed");
		};

		ajax.send(ajaxData);
	}

});

function showProgressAnimation() {
	$("#loading-div-background").show();
}

function hideProgressAnimation() {
	$("#loading-div-background").hide();
}


function setDownloadFile(filename){
	$('#DOWNLOAD_FILE')[0].value=filename;
}

// Get Presets Data 

var engine_methods=[]

function load_preset_tree() {
	$('#presets-search-panel').show();
	$('#presets-new-bank-panel').show();
	$('#presets-bank-panel').hide();
	$('#presets-file-panel').hide();

	$('#presets-tree').hide()
	$("#loading-tree").show()
	$("#error-message-tree").hide()

	$.post("lib-presets/get_tree", 
		$('#presets-form').serialize(),
		function(data, status) {
			$("#loading-tree").hide()
				if (status=="success") {
				if ("errors" in data) {
					$("#error-message-tree").html(data["errors"])
					$("#error-message-tree").show(600)
				}
				if ("methods" in data) {
					engine_methods = data['methods']
				}
				if ("presets" in data) {
					renderPresetsTree(data['presets'])
				}
			} else {
				$("#error-message-tree").html("Can't do " + action + ": " + status)
				$("#error-message-tree").show(600)
			}
		}
	)
	return false
}

function do_action(action=null) {
	$("#button-" + action).hide()
	$("#loading-action-" + action).show()
	$("#error-message-action").hide()

	$.post("lib-presets/" + action, 
		$('#presets-form').serialize(),
		function(data, status) {
			$("#button-" + action).show()
			$("#loading-action-" + action).hide()
			if (status=="success") {
				if ("errors" in data) {
					$("#error-message-action").html(data["errors"])
					$("#error-message-action").show(600)
				}
				if ("methods" in data) {
					engine_methods = data['methods']
				}
				if ("presets" in data) {
					renderPresetsTree(data['presets'])
				}
			} else {
				$("#error-message-action").html("Can't do " + action + ": " + status)
				$("#error-message-action").show(600)
			}
		}
	)
	return false
}

function do_download() {
	$("#presets-form").get(0).action="/lib-presets/download"
}

function renderPresetsTree(data) {
	$('#presets-tree').show()
	$('#presets-tree').treeview({
		data: data,
		bootstrap2: true,
		levels: 2,
		emptyIcon: "glyphicon glyphicon-floppy-disk",
		expandIcon: "glyphicon glyphicon-folder-close",
		collapseIcon: "glyphicon glyphicon-folder-open",
		onNodeSelected: function(event, data) {
			$("#loading-div-background").css({ opacity: 1.0 });
			$('#presets-search-panel').show();
			$('#presets-new-bank-panel').hide();
			$('#presets-bank-panel').hide();
			$('#presets-file-panel').hide();
			$('#download-panel').hide();
			$('#SEL_BANK_NAME').val('');
			$('#SEL_PRESET_NAME').val('');
			$('#SEL_NODE_ID').val(data.id);
			$("#SEL_FULLPATH").val(data.fullpath);
			//$("#presets-upload-form").attr("action", "/upload?redirectUrl=/lib-presets&destinationPath=" + data.full_path + "&clientId=" + $('#input-uploadfile-session')[0].value);

			if (data.node_type == 'BANK') {
				$('#SEL_BANK_NAME').val(data.name);
				if (engine_methods.includes("zynapi_new_bank")) $('#presets-new-bank-panel').show();
				if (engine_methods.includes("zynapi_rename_bank")) {
					$('#presets-bank-panel').show();
					$('#download-panel').show();
				}
				//$('#input-uploadfile-type')[0].value = data.bankType;
			} else if (data.node_type == 'PRESET') {
				$('#SEL_PRESET_NAME').val(data.name);
				if (engine_methods.includes("zynapi_rename_preset")) {
					$('#presets-file-panel').show();
					$('#download-panel').show();
				}
			}
		}
	});

	var node_id = parseInt($("#SEL_NODE_ID").val())
	$('#presets-tree').treeview('collapseAll', { silent: true });
	$('#presets-tree').treeview('revealNode', [ node_id, { silent: true } ]);
	$('#presets-tree').treeview('selectNode', node_id);
}


</script>
